<%= form_for @order, url: order_path do |f| %>
    <section id="cart_items">
      <div class="container">
        <div class="table-responsive cart_info">
          <table class="table table-condensed">
            <thead>
            <tr class="cart_menu">
              <td class="image_header">Image</td>
              <td class="description_header">Item</td>
              <td class="color_header">Color</td>
              <td class="size_header">Size</td>
              <td class="material_header">Material</td>
              <td class="quantity_header">Quantity</td>
              <td class="quantity_header">Price</td>
              <td class="quantity_header">Total</td>
              <td></td>
            </tr>
            </thead>
            <tbody>
            <% @cart_items.each do |cart_item| %>
                <% @item_variant = cart_item_variant(cart_item.item_variant_id) %>
                <%= f.fields_for :order_details, @order_details do |ff| %>
                    <%= ff.hidden_field :item_variant_id, value: cart_item.item_variant_id %>
                    <tr id="<%= cart_item.id %>">
                      <td class="cart_product">
                        <%= link_to item_path(@item_variant.item) do %>
                            <%= image_tag @item_variant.item.item_variants.first.item_image, class: 'cart_item_image' %>
                        <% end %>
                      </td>
                      <td class="cart_description">
                        <p><strong><%= @item_variant.name %></strong></p>
                      </td>
                      <td class="cart_color">
                        <p><%= @item_variant.color.name.capitalize %></p>
                      </td>
                      <td class="cart_size">
                        <p><%= @item_variant.size.name.capitalize %></p>
                      </td>
                      <td class="cart_material">
                        <p><%= @item_variant.material.name.capitalize if @item_variant.material %></p>
                      </td>
                      <td class="cart_quantity">
                        <div class="cart_quantity_button">
                          <%= ff.number_field :quantity, value: cart_item.quantity, class: 'cart_quantity_input', min: 1, autocomplete: 'off' %>
                        </div>
                      </td>
                      <td class="cart_material cart_item_price">
                        <% _price = ItemPricing.item_price(@item_variant.item, current_user).price %>
                        <p><%= _price %></p>
                      </td>
                      <td class="cart_material cart_item_total">
                        <p><%= cart_item.quantity * (_price || 1) %></p>
                      </td>
                      <td class="cart_quantity cart_delete">
                        <%= link_to remove_cart_item_path(cart_item), method: :delete, remote: true, class: "cart_quantity_delete" do %>
                            <i class="fa fa-times"></i>
                        <% end %>
                      </td>
                    </tr>
                <% end %>
            <% end %>

            <!--================= Cart Item End ======================== -->
            </tbody>
          </table>
        </div>
      </div>
    </section> <!--/#cart_items-->

    <section id="do_action">
      <div class="container">
        <div class="row">
          <div class="col-sm-6">
            <div class="heading cart_info">
              <h3>Heading for order level information?</h3>

              <p>Information required to show regarding the order to be placed.</p>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="total_area">
              <ul>
                <li>Total items<span class="total_cart_items">
                  <%= current_user.cart_items.present? ? current_user.cart_items.count : 0 %>
                </span></li>
                <li>Total item quantities<span class="total_cart_quantity">
                  <%= current_user.cart_items.present? ? current_user.cart_items.collect(&:quantity).inject(&:+) : 0 %>
                </span></li>
                <li>Total value<span class="total_cart_value">
                  <%= current_user.cart_total_value %>
                </span></li>
              </ul>
              <%= f.submit 'Place order', class: 'btn btn-default check_out' %>
              <%= link_to 'Continue shopping', items_path, class: 'btn btn-default check_out' %>
              <!--<a class="btn btn-default check_out" href="">Check Out</a>-->
            </div>
          </div>
        </div>
      </div>
    </section>
<% end %>

<script>
    $(function () {
        function total_quantity() {
            var total_qty = 0;
            var _this = this;
            $.each($('input.cart_quantity_input'), function (index, item) {
                total_qty += parseInt($(item).val());
            });
            $('span.total_cart_quantity').html(total_qty);
        }

        if (<%= !current_user.cart_items.present? %>) $('.check_out').hide();

        $('input.cart_quantity_input, a.cart_quantity_delete').on('change', function () {
            total_quantity();


            var _price = parseInt($(this).parents('.cart_quantity').siblings('td.cart_item_price').find('p').text());
            var _total = parseInt($(this).val()) * _price;

            $(this).parents('.cart_quantity').siblings('td.cart_item_total').find('p').html(_total);
            var _totals = $.map($('td.cart_item_total'), function (obj) {
                return parseInt($(obj).find('p').text())
            });
            $('span.total_cart_value').html(eval(_totals.join('+')));
        });

        $('a.cart_quantity_delete').on('click', function () {
            total_quantity();
        });
    });
</script>